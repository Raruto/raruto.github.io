L.Control.Elevation=L.Control.extend({options:{position:"topright",theme:"lime-theme",width:600,height:175,margins:{top:10,right:20,bottom:30,left:50},useHeightIndicator:true,autoHideHeightIndicator:false,interpolation:d3.curveLinear,hoverNumber:{decimalsX:2,decimalsY:0,formatter:undefined},xTicks:undefined,yTicks:undefined,collapsed:false,yAxisMin:undefined,yAxisMax:undefined,forceAxisBounds:false,controlButton:{iconCssClass:"elevation-toggle-icon",title:"Elevation"},imperial:false,elevationDiv:"#elevation-div",detachedView:false,responsiveView:false,gpxOptions:{async:true,marker_options:{startIconUrl:null,endIconUrl:null,shadowUrl:null,},polyline_options:{color:"#FF005E",opacity:0.75,weight:5,lineCap:"round"},},},__mileFactor:0.621371,__footFactor:3.28084,onRemove:function(a){this._container=null},onAdd:function(d){this._map=d;var a=this.options;var i=a.margins;a.xTicks=a.xTicks||Math.round(this._width()/75);a.yTicks=a.yTicks||Math.round(this._height()/30);a.hoverNumber.formatter=a.hoverNumber.formatter||this._formatter;if(a.detachedView&&a.responsiveView){var l=document.querySelector(a.elevationDiv).offsetWidth;var e=document.querySelector(a.elevationDiv).offsetHeight;a.width=l>0?l:a.width;a.height=(e-20)>0?e-20:a.height-20}var n=this._x=d3.scaleLinear().range([0,this._width()]);var m=this._y=d3.scaleLinear().range([this._height(),0]);var f=this._area=d3.area().curve(a.interpolation).x(function(q){var g=n(q.dist);q.xDiagCoord=g;return g}).y0(this._height()).y1(function(g){return m(g.altitude)});var c=this._container=L.DomUtil.create("div","elevation");L.DomUtil.addClass(c,a.theme);this._initToggle();var p=d3.select(c);p.attr("width",a.width);var j=p.append("svg");j.attr("width",a.width).attr("class","background").attr("height",a.height).style("overflow","visible").append("g").attr("transform","translate("+i.left+","+i.top+")");var o=d3.line();o=o.x(function(g){return d3.mouse(j.select("g"))[0]}).y(function(g){return this._height()});var k=d3.select(this._container).select("svg").select("g");this._areapath=k.append("path").attr("class","area").style("paint-order","stroke fill");var b=this._background=k.append("rect").attr("width",this._width()).attr("height",this._height()).style("fill","none").style("stroke","none").style("pointer-events","all");if(L.Browser.touch){b.on("touchmove.drag",this._dragHandler.bind(this)).on("touchstart.drag",this._dragStartHandler.bind(this)).on("touchstart.focus",this._mousemoveHandler.bind(this));L.DomEvent.on(this._container,"touchend",this._dragEndHandler,this)}b.on("mousemove.drag",this._dragHandler.bind(this)).on("mousedown.drag",this._dragStartHandler.bind(this)).on("mousemove.focus",this._mousemoveHandler.bind(this)).on("mouseout.focus",this._mouseoutHandler.bind(this));L.DomEvent.on(this._container,"mouseup",this._dragEndHandler,this);this._xaxisgraphicnode=k.append("g");this._yaxisgraphicnode=k.append("g");this._appendXaxis(this._xaxisgraphicnode);this._appendYaxis(this._yaxisgraphicnode);var h=this._focusG=k.append("g").attr("class","mouse-focus-group");this._mousefocus=h.append("svg:line").attr("class","mouse-focus-line").attr("x2","0").attr("y2","0").attr("x1","0").attr("y1","0");this._focuslabelrect=h.append("rect").attr("class","mouse-focus-label").attr("x",0).attr("y",0).attr("width",0).attr("height",0).attr("rx",3).attr("ry",3).style("fill","#000").style("fill-opacity",0.75).style("pointer-events","none");this._focuslabeltext=h.append("svg:text").style("pointer-events","none").attr("class","mouse-focus-label-text").style("fill","#fff");this._focuslabelX=this._focuslabeltext.append("svg:tspan").attr("class","mouse-focus-label-y").attr("dy","-1em");this._focuslabelY=this._focuslabeltext.append("svg:tspan").attr("class","mouse-focus-label-y").attr("dy","2em");if(this._data){this._applyData()}this._map.on("zoom viewreset zoomanim",this._forceHidePositionMarker,this);this._map.on("resize",this._resetView,this);return c},_dragHandler:function(){d3.event.preventDefault();d3.event.stopPropagation();this._gotDragged=true;this._drawDragRectangle()},_dragStartHandler:function(){d3.event.preventDefault();d3.event.stopPropagation();this._gotDragged=false;this._dragStartCoords=d3.mouse(this._background.node())},_drawDragRectangle:function(){if(!this._dragStartCoords){return}var a=this._dragCurrentCoords=d3.mouse(this._background.node());var c=Math.min(this._dragStartCoords[0],a[0]),b=Math.max(this._dragStartCoords[0],a[0]);if(!this._dragRectangle&&!this._dragRectangleG){var d=d3.select(this._container).select("svg").select("g");this._dragRectangleG=d.insert("g",".mouse-focus-group");this._dragRectangle=this._dragRectangleG.append("rect").attr("width",b-c).attr("height",this._height()).attr("x",c).attr("class","mouse-drag").style("pointer-events","none")}else{this._dragRectangle.attr("width",b-c).attr("x",c)}},_dragEndHandler:function(){if(!this._dragStartCoords||!this._gotDragged){this._dragStartCoords=null;this._gotDragged=false;return}this._hidePositionMarker();var b=this._findItemForX(this._dragStartCoords[0]),a=this._findItemForX(this._dragCurrentCoords[0]);this._fitSection(b,a);this._dragStartCoords=null;this._gotDragged=false;this._map.fireEvent("elechart_dragged",{data:{dragstart:this._data[b],dragend:this._data[a]}},true)},_resetDrag:function(){if(this._dragRectangleG){this._dragRectangleG.remove();this._dragRectangleG=null;this._dragRectangle=null;this._hidePositionMarker();this._map.fitBounds(this._fullExtent)}},_findItemForX:function(a){var c=d3.bisector(function(e){return e.dist}).left;var b=this._x.invert(a);return c(this._data,b)},_findItemForLatLng:function(c){var a=null,b=Infinity;this._data.forEach(function(d){var e=c.distanceTo(d.latlng);if(e<b){b=e;a=d}});return a},_fitSection:function(e,c){var d=Math.min(e,c),a=Math.max(e,c);var b=this._calculateFullExtent(this._data.slice(d,a));this._map.fitBounds(b)},_initToggle:function(){var a=this._container;a.setAttribute("aria-haspopup",true);L.DomEvent.disableClickPropagation(a);if(L.Browser.touch){L.DomEvent.on(a,"click",L.DomEvent.stopPropagation)}if(this.options.collapsed){this._collapse();if(!L.Browser.android){L.DomEvent.on(a,"mouseover",this._expand,this).on(a,"mouseout",this._collapse,this)}var b=this._button=L.DomUtil.create("a","elevation-toggle "+this.options.controlButton.iconCssClass,a);b.href="#";b.title=this.options.controlButton.title;if(L.Browser.touch){L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",this._expand,this)}L.DomEvent.on(b,"focus",this._expand,this);this._map.on("click",this._collapse,this)}},_expand:function(){this._container.className=this._container.className.replace(" elevation-collapsed","")},_collapse:function(){L.DomUtil.addClass(this._container,"elevation-collapsed")},_width:function(){var a=this.options;return a.width-a.margins.left-a.margins.right},_height:function(){var a=this.options;return a.height-a.margins.top-a.margins.bottom},_formatter:function(c,g,b){var e;if(g===0){e=Math.round(c)+""}else{e=L.Util.formatNum(c,g)+""}var a=e.split(".");if(a[1]){var f=g-a[1].length;for(;f>0;f--){a[1]+="0"}e=a.join(b||".")}return e},_appendYaxis:function(b){var a=this.options;if(a.imperial){b.attr("class","y axis").call(d3.axisLeft().scale(this._y).ticks(this.options.yTicks)).append("text").attr("x",-37).attr("y",3).style("text-anchor","end").text("ft")}else{b.attr("class","y axis").call(d3.axisLeft().scale(this._y).ticks(this.options.yTicks)).append("text").attr("x",-30).attr("y",3).style("text-anchor","end").style("fill","#000").style("font-weight","700").text("m")}},_appendXaxis:function(a){var b=this.options;if(b.imperial){a.attr("class","x axis").attr("transform","translate(0,"+this._height()+")").call(d3.axisBottom().scale(this._x).ticks(this.options.xTicks)).append("text").attr("x",this._width()+10).attr("y",15).style("text-anchor","end").text("mi")}else{a.attr("class","x axis").attr("transform","translate(0,"+this._height()+")").call(d3.axisBottom().scale(this._x).ticks(this.options.xTicks)).append("text").attr("x",this._width()+6).attr("y",30).style("text-anchor","end").style("fill","#000").style("font-weight","700").text("km")}},_updateAxis:function(){this._xaxisgraphicnode.selectAll("g").remove();this._xaxisgraphicnode.selectAll("path").remove();this._xaxisgraphicnode.selectAll("text").remove();this._yaxisgraphicnode.selectAll("g").remove();this._yaxisgraphicnode.selectAll("path").remove();this._yaxisgraphicnode.selectAll("text").remove();this._appendXaxis(this._xaxisgraphicnode);this._appendYaxis(this._yaxisgraphicnode)},_mouseoutHandler:function(){},_resetView:function(){this._resetDrag();this._forceHidePositionMarker()},_forceHidePositionMarker:function(){this._hidePositionMarker(true)},_hidePositionMarker:function(a){if(!this.options.autoHideHeightIndicator&&!a){return}if(this._marker){this._map.removeLayer(this._marker);this._marker=null}if(this._mouseHeightFocus){this._mouseHeightFocus.style("visibility","hidden");this._mouseHeightFocusLabel.style("visibility","hidden")}if(this._pointG){this._pointG.style("visibility","hidden")}this._focusG.style("visibility","hidden")},_mousemoveHandler:function(f,b,a){if(!this._data||this._data.length===0){return}var e=d3.mouse(this._background.node());var c=this._data[this._findItemForX(e[0])];this._forceHidePositionMarker();this._showDiagramIndicator(c,e[0]);this._showPositionMarker(c);this._map.fireEvent("elechart_change",{data:c},true)},_showPositionMarker:function(j){var a=this.options,c=j.altitude,g=j.dist,h=j.latlng,k=a.hoverNumber.formatter(c,a.hoverNumber.decimalsY),l=a.hoverNumber.formatter(g,a.hoverNumber.decimalsX);var b=this._map.latLngToLayerPoint(h);if(a.useHeightIndicator){if(!this._mouseHeightFocus){var f=d3.select(this._map.getContainer()).select(".leaflet-overlay-pane svg").append("g");this._mouseHeightFocus=f.append("svg:line").attr("class",a.theme+" height-focus line").attr("x2",0).attr("y2",0).attr("x1",0).attr("y1",0);var i=this._pointG=f.append("g");i.append("svg:circle").attr("r",6).attr("cx",0).attr("cy",0).attr("class",a.theme+" height-focus circle-lower");this._mouseHeightFocusLabel=f.append("svg:text").attr("class",a.theme+" height-focus-label").style("pointer-events","none")}var e=this._height()/this._maxElevation*c;var d=b.y-e;this._mouseHeightFocus.attr("x1",b.x).attr("x2",b.x).attr("y1",b.y).attr("y2",d).style("visibility","visible");this._pointG.attr("transform","translate("+b.x+","+b.y+")").style("visibility","visible");if(a.imperial){this._mouseHeightFocusLabel.attr("x",b.x).attr("y",d).text(k+" ft").style("visibility","visible")}else{this._mouseHeightFocusLabel.attr("x",b.x).attr("y",d).text(k+" m").style("visibility","visible")}}else{if(!this._marker){this._marker=new L.Marker(h).addTo(this._map)}else{this._marker.setLatLng(h)}}},_addGeoJSONData:function(g){var a=this.options;if(g){var b=this._data||[];var f=this._dist||0;var j=this._maxElevation||0;for(var c=0;c<g.length;c++){var k=new L.LatLng(g[c][1],g[c][0]);var d=new L.LatLng(g[c?c-1:0][1],g[c?c-1:0][0]);var h=a.imperial?k.distanceTo(d)*this.__mileFactor:k.distanceTo(d);f=f+Math.round(h/1000*100000)/100000;if(typeof g[c][2]!=="undefined"){j=j<g[c][2]?g[c][2]:j;b.push({dist:f,altitude:a.imperial?g[c][2]*this.__footFactor:g[c][2],x:g[c][0],y:g[c][1],latlng:k})}}this._dist=f;this._data=b;j=a.imperial?j*this.__footFactor:j;this._maxElevation=j}},_addGPXdata:function(g){var a=this.options;if(g){var b=this._data||[];var f=this._dist||0;var j=this._maxElevation||0;for(var c=0;c<g.length;c++){var k=g[c];var d=g[c?c-1:0];var h=a.imperial?k.distanceTo(d)*this.__mileFactor:k.distanceTo(d);f=f+Math.round(h/1000*100000)/100000;if(typeof k.meta.ele!=="undefined"){j=j<k.meta.ele?k.meta.ele:j;b.push({dist:f,altitude:a.imperial?k.meta.ele*this.__footFactor:k.meta.ele,x:k.lng,y:k.lat,latlng:k})}}this._dist=f;this._data=b;j=a.imperial?j*this.__footFactor:j;this._maxElevation=j}},_addData:function(e){var b=e&&e.geometry&&e.geometry;var a;if(b){switch(b.type){case"LineString":this._addGeoJSONData(b.coordinates);break;case"MultiLineString":for(a=0;a<b.coordinates.length;a++){this._addGeoJSONData(b.coordinates[a])}break;default:throw new Error("Invalid GeoJSON object.")}}var c=e&&e.type==="FeatureCollection";if(c){for(a=0;a<e.features.length;a++){this._addData(e.features[a])}}if(e&&e._latlngs){this._addGPXdata(e._latlngs)}},_calculateFullExtent:function(b){if(!b||b.length<1){throw new Error("no data in parameters")}var a=new L.latLngBounds(b[0].latlng,b[0].latlng);b.forEach(function(c){a.extend(c.latlng)});return a},addData:function(b,a){this._addData(b);if(this._container){this._applyData()}if(a===null&&b.on){a=b}if(a){a.on("mousemove",this._handleLayerMouseOver.bind(this)).on("mouseout",this._mouseoutHandler.bind(this))}},addGPXFile:function(a){if(!a){throw"Invalid gpx url"}var d=this.options.theme;var c=d.substring(0,d.indexOf("-theme"));var b;switch(c){case"lime":b="#566B13";break;case"steelblue":b="#4682B4";break;case"purple":b="#732C7B";break;case"magenta":b="#FF005E";break;default:b=this.options.gpxOptions.polyline_options.color;break}this.options.gpxOptions.polyline_options.color=b;this.gpx=new L.GPX(a,this.options.gpxOptions);this.gpx.on("loaded",function(f){this._map.fitBounds(f.target.getBounds())});this.gpx.once("addline",function(f){this.addData(f.line,this.gpx)},this);this.gpx.addTo(this._map);this._map.on("resize",function(i){var g=this._map.getContainer();var j=document.querySelector(this.options.elevationDiv);var h=j.offsetWidth;if(h<=0){return}this.options.width=h;j.innerHTML="";var f=this.onAdd(this._map);f.classList.add("leaflet-control");if(this.options.detachedView){j.appendChild(f)}else{this.addTo(this._map)}},this)},_handleLayerMouseOver:function(b){if(!this._data||this._data.length===0){return}var d=b.latlng;var c=this._findItemForLatLng(d);if(c){var a=c.xDiagCoord;this._forceHidePositionMarker();this._showDiagramIndicator(c,a);this._showPositionMarker(c)}},_showDiagramIndicator:function(h,b){var a=this.options;this._focusG.style("visibility","visible");this._mousefocus.attr("x1",b).attr("y1",0).attr("x2",b).attr("y2",this._height()).classed("hidden",false);var c=h.altitude,d=h.dist,e=h.latlng,i=a.hoverNumber.formatter(c,a.hoverNumber.decimalsY),j=a.hoverNumber.formatter(d,a.hoverNumber.decimalsX);this._focuslabeltext.attr("x",b).attr("y",this._y(h.altitude)).style("font-weight","700");this._focuslabelX.text(i+(a.imperial?" ft":" m")).attr("x",b+10);this._focuslabelY.text(j+(a.imperial?" mi":" km")).attr("x",b+10);var g=this._focuslabeltext.node().getBBox();var f=2;this._focuslabelrect.attr("x",g.x-f).attr("y",g.y-f).attr("width",g.width+(f*2)).attr("height",g.height+(f*2))},_applyData:function(){var a=d3.extent(this._data,function(e){return e.dist});var c=d3.extent(this._data,function(e){return e.altitude});var b=this.options;if(b.yAxisMin!==undefined&&(b.yAxisMin<c[0]||b.forceAxisBounds)){c[0]=b.yAxisMin}if(b.yAxisMax!==undefined&&(b.yAxisMax>c[1]||b.forceAxisBounds)){c[1]=b.yAxisMax}this._x.domain(a);this._y.domain(c);this._areapath.datum(this._data).attr("d",this._area);this._updateAxis();this._fullExtent=this._calculateFullExtent(this._data)},_clearData:function(){this._data=null;this._dist=null;this._maxElevation=null},clear:function(){this._clearData();if(!this._areapath){return}this._areapath.attr("d","M0 0");this._x.domain([0,1]);this._y.domain([0,1]);this._updateAxis()},hide:function(){this._container.style.display="none"},show:function(){this._container.style.display="block"},_addToElevationDiv:function(b){var a=this.onAdd(b);a.classList.add("leaflet-control");var c=document.querySelector(this.options.elevationDiv);c.appendChild(a)},loadGPX:function(b,a){if(this.options.detachedView){this._addToElevationDiv(b)}else{this.addTo(b)}this.addGPXFile(a)}});L.control.elevation=function(a){return new L.Control.Elevation(a)};