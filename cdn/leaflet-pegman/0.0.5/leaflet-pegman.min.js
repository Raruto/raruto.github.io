L.Control.Pegman=L.Control.extend({includes:L.Evented?L.Evented.prototype:L.Mixin.Events,options:{position:"bottomright",clickableStreetViewLayer:false,theme:"leaflet-pegman-v3-default",logging:false,},initialize:function(a){L.Util.setOptions(this,a);this._mousePos={direction:{},old:{},};this._pegmanMarkerCoords=null;this._streetViewCoords=null;this._streetViewLayerEnabled=false;this.options.clickableStreetViewLayer=typeof(L.gridLayer.googleMutant)==="undefined"||this.options.clickableStreetViewLayer;this._dropzoneMapOpts={accept:".draggable",overlap:0.75,ondropactivate:L.bind(this.onDropZoneActivated,this),ondragenter:L.bind(this.onDropZoneDragEntered,this),ondragleave:L.bind(this.onDropZoneDragLeaved,this),ondrop:L.bind(this.onDropZoneDropped,this),ondropdeactivate:L.bind(this.onDropZoneDeactivated,this),};this._draggableMarkerOpts={inertia:false,onmove:L.bind(this.onDraggableMove,this),onend:L.bind(this.onDraggableEnd,this),};this._pegmanMarkerOpts={draggable:true,icon:L.icon({className:"pegman-marker",iconSize:[52,52],iconAnchor:[26,13],iconUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAFElEQVR4XgXAAQ0AAABAMP1L30IDCPwC/o5WcS4AAAAASUVORK5CYII=",}),}},onAdd:function(a){this._map=a;this._container=L.DomUtil.create("div","leaflet-pegman pegman-control leaflet-bar");this._pegman=L.DomUtil.create("div","pegman draggable drag-drop",this._container);this._pegmanButton=L.DomUtil.create("div","pegman-button",this._container);this._pegmanMarker=L.marker([0,0],this._pegmanMarkerOpts);this._panoDiv=L.DomUtil.create("div","pano-canvas",this._map._container);if(this.options.theme){L.DomUtil.addClass(this._map._container,this.options.theme)}if(this.options.clickableStreetViewLayer){this._googleStreetViewLayer=L.tileLayer("https://{s}.googleapis.com/vt?lyrs=svv&style=40,18&x={x}&y={y}&z={z}",{attribution:'Map data: &copy; <a href="https://www.google.com/intl/en/help/terms_maps.html">Google</a>',subdomains:["mts1","mts2","mts3"],pane:"overlayPane",});this._mouseTileTracker=new this.MouseTileTracker(this._map)}else{this._googleStreetViewLayer=L.gridLayer.googleMutant({attribution:'Map data: &copy; <a href="https://www.google.com/intl/en/help/terms_maps.html">Google</a>',pane:"overlayPane",type:"roadmap",styles:[{stylers:[{visibility:"off"}]}]});this._googleStreetViewLayer.addGoogleLayer("StreetViewCoverageLayer")}this._panorama=new google.maps.StreetViewPanorama(this._panoDiv,{enableCloseButton:true,});this._streetViewService=new google.maps.StreetViewService();this._draggable=interact(this._pegman).draggable(this._draggableMarkerOpts);this._dropzone=interact(this._map._container).dropzone(this._dropzoneMapOpts);this._draggable.styleCursor(false);interact(this._container).on("tap",L.bind(this.toggleStreetViewLayer,this));L.DomEvent.disableClickPropagation(this._container);L.DomEvent.disableClickPropagation(this._panoDiv);L.DomEvent.on(document,"mousemove",this.mouseMoveTracking,this);L.DomEvent.on(document,"keyup",this.keyUpTracking,this);this._pegmanMarker.on("dragend",this.onPegmanMarkerDragged,this);this._map.on("click",this.onMapClick,this);this._map.on("layeradd",this.onMapLayerAdd,this);google.maps.event.addListener(this._panorama,"closeclick",L.bind(this.onStreetViewPanoramaClose,this));return this._container},onRemove:function(a){this._googleStreetViewLayer.remove();this._pegmanMarker.remove();L.DomUtil.remove(this._panoDiv);L.DomEvent.off(document,"mousemove",this.mouseMoveTracking,this);L.DomEvent.off(document,"keyup",this.keyUpTracking,this)},_log:function(a){if(this.options.logging){console.log(a)}},_addClasses:function(b,c){var c=c.split(" ");for(var a in c){L.DomUtil.addClass(b,c[a])}},_removeClasses:function(b,c){var c=c.split(" ");for(var a in c){L.DomUtil.removeClass(b,c[a])}},_removeAttributes:function(c,d){for(var b in d){c.removeAttribute(d[b])}},_insertAfter:function(b,a){b.parentNode.insertBefore(a,b.nextSibling)},_translateElement:function(d,c,b){if(c===false&&b===false){this._removeAttributes(this._pegman,["style","data-x","data-y"])}var a=(parseFloat(d.getAttribute("data-x"))||0)+c;var e=(parseFloat(d.getAttribute("data-y"))||0)+b;d.style.webkitTransform=d.style.transform="translate("+a+"px, "+e+"px)";d.setAttribute("data-x",a);d.setAttribute("data-y",e)},_updateClasses:function(a){switch(a){case"pegman-dragging":this._removeClasses(this._pegman,"dropped");this._addClasses(this._container,"dragging");break;case"pegman-dragged":this._removeClasses(this._pegman,"can-drop dragged left right active dropped");this._removeAttributes(this._pegman,["style","data-x","data-y"]);break;case"dropzone-actived":this._addClasses(this._map._container,"drop-active");break;case"dropzone-drag-entered":this._addClasses(this._pegman,"active can-drop");this._addClasses(this._map._container,"drop-target");break;case"dropzone-drag-leaved":this._removeClasses(this._map._container,"drop-target");this._removeClasses(this._pegman,"can-drop");break;case"dropzone-drop":this._removeClasses(this._container,"dragging");this._removeClasses(this._pegman,"active left right");this._addClasses(this._pegman,"dropped");this._removeClasses(this._pegman,"can-drop dragged left right active dropped");break;case"dropzone-deactivated":this._removeClasses(this._pegman,"active left right");this._removeClasses(this._map._container,"drop-active drop-target");break;case"mousemove-top":this._addClasses(this._pegman,"top");this._removeClasses(this._pegman,"bottom right left");break;case"mousemove-bottom":this._addClasses(this._pegman,"bottom");this._removeClasses(this._pegman,"top right left");break;case"mousemove-left":this._addClasses(this._pegman,"left");this._removeClasses(this._pegman,"right top bottom");break;case"mousemove-right":this._addClasses(this._pegman,"right");this._removeClasses(this._pegman,"left top bottom");break;case"pegman-added":this._addClasses(this._container,"active");break;case"pegman-removed":this._removeClasses(this._container,"active");break;case"streetview-shown":this._addClasses(this._container,"streetview-layer-active");break;case"streetview-hidden":this._removeClasses(this._container,"streetview-layer-active");break;default:throw"Unhandled event:"+a;return}this._log(a);this.fireEvent("svpc_"+a)},onDraggableMove:function(a){this.mouseMoveTracking(a);this._updateClasses("pegman-dragging");this._translateElement(this._pegman,a.dx,a.dy)},onDraggableEnd:function(a){this._pegmanMarkerCoords=this._map.mouseEventToLatLng(a);this.pegmanAdd();this._updateClasses("pegman-dragged")},onDropZoneActivated:function(a){this._updateClasses("dropzone-actived")},onDropZoneDragEntered:function(a){this.showStreetViewLayer();this._updateClasses("dropzone-drag-entered")},onDropZoneDragLeaved:function(a){this._updateClasses("dropzone-drag-leaved")},onDropZoneDropped:function(a){this._updateClasses("dropzone-drop");this._translateElement(this._pegman,false,false)},onDropZoneDeactivated:function(a){this._updateClasses("dropzone-deactivated")},onPegmanMarkerDragged:function(a){this._pegmanMarkerCoords=this._pegmanMarker.getLatLng();this.findStreetViewData(this._pegmanMarkerCoords.lat,this._pegmanMarkerCoords.lng)},onMapClick:function(a){if(this._streetViewLayerEnabled){this.findStreetViewData(a.latlng.lat,a.latlng.lng)}},onMapLayerAdd:function(a){this._googleStreetViewLayer.bringToFront()},onStreetViewPanoramaClose:function(){this.clear()},clear:function(){this.pegmanRemove();this.hideStreetViewLayer();this.closeStreetViewPanorama()},toggleStreetViewLayer:function(a){this._streetViewLayerEnabled?this.clear():this.showStreetViewLayer()},pegmanAdd:function(){this._pegmanMarker.addTo(this._map);this._pegmanMarker.setLatLng(this._pegmanMarkerCoords);this.findStreetViewData(this._pegmanMarkerCoords.lat,this._pegmanMarkerCoords.lng);this._updateClasses("pegman-added")},pegmanRemove:function(){this._pegmanMarker.removeFrom(this._map);this._updateClasses("pegman-removed")},closeStreetViewPanorama:function(){this._panoDiv.style.display="none"},openStreetViewPanorama:function(){this._panoDiv.style.display="block"},hideStreetViewLayer:function(){this._googleStreetViewLayer.removeFrom(this._map);this._streetViewLayerEnabled=false;this._updateClasses("streetview-hidden")},showStreetViewLayer:function(){this._googleStreetViewLayer.addTo(this._map);this._streetViewLayerEnabled=true;this._updateClasses("streetview-shown")},findStreetViewData:function(d,b){this._streetViewCoords=new google.maps.LatLng(d,b);var c=this._map.getZoom();var a=100;if(c<6){a=5000}else{if(c<10){a=500}else{if(c<15){a=250}else{if(c>=17){a=50}else{a=100}}}}this._streetViewService.getPanoramaByLocation(this._streetViewCoords,a,L.bind(this.processStreetViewServiceData,this))},processStreetViewServiceData:function(b,a){if(a==google.maps.StreetViewStatus.OK){this.openStreetViewPanorama();this._panorama.setPano(b.location.pano);this._panorama.setPov({heading:google.maps.geometry.spherical.computeHeading(b.location.latLng,this._streetViewCoords),pitch:0,zoom:0});this._panorama.setVisible(true)}else{this._log("Street View data not found for this location.")}},mouseMoveTracking:function(b){var a=this._mousePos;if(b.pageY<a.old.y){a.direction.y="top";this._updateClasses("mousemove-top")}else{if(b.pageY>a.old.y){a.direction.y="bottom";this._updateClasses("mousemove-bottom")}}if(b.pageX<a.old.x){a.direction.x="left";this._updateClasses("mousemove-left")}else{if(b.pageX>a.old.x){a.direction.x="right";this._updateClasses("mousemove-right")}}a.old.x=b.pageX;a.old.y=b.pageY},keyUpTracking:function(a){if(a.keyCode==27){this._log("escape pressed");this.clear()}},MouseTileTracker:function(b){var a=this;a._init=function(c){a.map=c;a.mouse={pageX:0,pageY:0};if(typeof(Number.prototype.toRad)==="undefined"){Number.prototype.toRad=function(){return this*Math.PI/180}}a.defaultDraggableCursor=a.map._container.style.cursor;a.map._container.addEventListener("mousemove",a.onMapDivMouseMove);a.map.on("mousemove",a.onMapMouseMove)};a.getTileURL=function(f,g,e){var c=parseInt(Math.floor((g+180)/360*(1<<e)));var d=parseInt(Math.floor((1-Math.log(Math.tan(f.toRad())+1/Math.cos(f.toRad()))/Math.PI)/2*(1<<e)));return{x:c,y:d,z:e,}};a._startTracking=function(f,h,j,c,g){g=g||null;a.tileData=null;a.downloadedTile=null;a.tileCanvas=null;a.tileSrc="";a.baseUrl=f;a.tileCoordinate=h;a.tileWidth=j;a.tileHeight=c;var d=/(^\w+:|^)\/\//;var i=/.*\{s\}.*\./;var e;a.tileSrc=a.baseUrl;a.tileSrc=a.tileSrc.replace("{x}",a.tileCoordinate.x);a.tileSrc=a.tileSrc.replace("{y}",a.tileCoordinate.y);a.tileSrc=a.tileSrc.replace("{z}",a.map.getZoom());e=a.tileSrc;if(g){a.tileSrc=a.tileSrc.replace("{s}",g)}e=e.replace(d,"");e=e.replace(i,"");a.downloadTile(a.tileSrc);if(!a.tileData){a.tileLoaded()}a.mapTile=document.querySelector('.leaflet-container img[src$="'+e+'"]');if(!a.mapTile){return}a.rect=a.mapTile.getBoundingClientRect();a.imgPos={top:(a.rect.top+window.scrollY).toFixed(0),left:(a.rect.left+window.scrollX).toFixed(0)};a.mousePos={x:a.mouse.pageX-a.imgPos.left,y:a.mouse.pageY-a.imgPos.top};a.pixelData=a.tileCanvas.getContext("2d").getImageData(a.mousePos.x,a.mousePos.y,1,1).data;a.alpha=a.pixelData[3];a.hasTileData=(a.alpha!=0)};a.downloadTile=function(c){a.downloadedTile=new Image();a.downloadedTile.crossOrigin="Anonymous";a.downloadedTile.addEventListener("load",a.tileLoaded,false);a.downloadedTile.src=c};a.tileLoaded=function(){a.tileCanvas=document.createElement("canvas");a.context=a.tileCanvas.getContext("2d");a.tileCanvas.width=a.tileWidth;a.tileCanvas.height=a.tileHeight;a.context.drawImage(a.downloadedTile,0,0);a.tileData=a.context.getImageData(0,0,a.tileWidth,a.tileHeight)};a.onMapDivMouseMove=function(c){a.mouse.pageX=c.pageX;a.mouse.pageY=c.pageY};a.onMapMouseMove=function(g){var c=256;var l=a.getTileURL(g.latlng.lat,g.latlng.lng,a.map.getZoom());var d=a.map._layers;var k,h=false;var e;var j;for(var f in d){var j=d[f];if(!j._url||j._url.indexOf("google")<0){continue}if(j.options&&j.options.subdomains&&j.options.subdomains[0]){e=j.options.subdomains[0]}else{e=null}a._startTracking(j._url,l,c,c,e);if(a.hasTileData){h=true}}a.map._container.style.cursor=h?"pointer":a.defaultDraggableCursor};a._init(b)},});L.control.pegman=function(a){return new L.Control.Pegman(a)};
